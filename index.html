<!DOCTYPE html>
<html>

<head>
  <title>leaflet-map-csv</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8">

  <link rel="stylesheet" type="text/css" href="style.css">

  <!-- For the search box -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

  <!-- Load Leaflet code library - see updates at http://leafletjs.com/download.html -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.css" />

  <!-- Position the map with Cascading Style Sheet (CSS) -->
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      right: 0;
      left: 0;
    }
  </style>

</head>

<body>

  <!-- Insert HTML division tag to layout the map -->
  <div id="map"></div>

  <!-- Insert Javascript (.js) code to create the map -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet.featuregroup.subgroup/dist/leaflet.featuregroup.subgroup-src.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.js"></script>

  <!-- Insert JavaScript code to create the map and add engineer layers -->
  <script>
    var map = L.map('map', {
      center: [34.098907, -118.327759],
      zoom: 9,
      tap: false
    });

    var light = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy; <a href="https://carto.com/attribution">CARTO</a>'
    }).addTo(map);

    var terrain = L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/terrain/{z}/{x}/{y}.png', {
      attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.'
    });

    var googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
      maxZoom: 20,
      subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
    });

    var baseLayers = {
      "Carto Light Basemap": light,
      "Stamen Terrain Basemap": terrain,
      "Satellite Basemap": googleSat,
    };


    //THIS IS THE SEARCH FUNCTION
    var geocoder = L.Control.geocoder()
      .on('markgeocode', function (event) {
        var center = event.geocode.center;
        L.marker(center).addTo(map);
        map.setView(center, 13);
        //L.circle(center, 900).addTo(map);  this creates a radius everytime you search
      })
      .addTo(map);



    //leaflet draw plugin
    var drawnFeatures = new L.FeatureGroup();
    map.addLayer(drawnFeatures);

    var drawControl = new L.Control.Draw({
      edit: {
        featureGroup: drawnFeatures,
        remove: true
      },
      draw: {
        polygon: {
          shapeOptions: {
            color: 'red'
          },
        },
        polyline: {
          shapeOptions: {
            color: 'green'
          },
        },
        rect: {
          shapeOptions: {
            color: 'purple'
          },
        },
        circle: {
          shapeOptions: {
            color: 'blue',
          },
        },
        marker: false,
      },
    });

    //to remove any of these shapes just do the follow: circle: false,

    map.addControl(drawControl);

    map.on("draw:created", function (e) {
      var type = e.layerType;
      var layer = e.layer;
      drawnFeatures.addLayer(layer);
    });

    map.on("draw:edited", function (e) {
      var layers = e.layers;
      layers.eachLayer(function (layer) {
      });
    });




    var controlLayers = L.control.layers(baseLayers);

    var engineerLayers = {}; // Create an object to hold the engineer marker cluster groups
    var subgroups = [];
    //this read the data file

    $.get('./data.csv', function (csvString) {
      var data = Papa.parse(csvString, {
        header: true,
        dynamicTyping: true
      }).data;

      // Create a parent feature group
      var parentGroup = L.featureGroup.subGroup(null, []);

      // Loop through the data and create marker clusters for each engineer
      for (var i = 0; i < data.length; i++) {
        var row = data[i];
        var marker;
        var engineer = row.Engineer;

        if (!(engineer in engineerLayers)) {
          var subgroup = L.featureGroup.subGroup(null, []);

          engineerLayers[engineer] = L.markerClusterGroup({
            spiderfyOnMaxZoom: false,
            showCoverageOnHover: true,
            zoomToBoundsOnClick: true
          });

          subgroup.addTo(map);
          subgroups.push({
            subgroup: subgroup,
            parentGroup: null
          });
          controlLayers.addOverlay(engineerLayers[engineer], engineer);
        }

        marker = L.circleMarker([row.Latitude, row.Longitude], {
          radius: 10,
          stroke: true,
          color: getColor(engineer),
          opacity: 1,
          weight: 1,
          fill: true,
          fillColor: getColor(engineer),
          fillOpacity: 0.5
        }).bindPopup('Plan File: ' + row.PFN + '</br>' + 'Engineer: ' + row.Engineer);

        engineerLayers[engineer].addLayer(marker);
      }

      // Add the parent group to the map
      parentGroup.addTo(map);
      controlLayers.addTo(map);
    });

    // Add event listeners to handle showing and hiding markers and clusters
    controlLayers.on('overlayadd', function (eventLayer) {
      var engineer = eventLayer.name;
      if (engineer in engineerLayers) {
        var index = getSubgroupIndex(engineer);
        if (index !== -1) {
          var subgroup = subgroups[index].subgroup;
          var parentGroup = subgroups[index].parentGroup;
        }
      }
    });



    controlLayers.on('overlayremove', function (eventLayer) {
      var engineer = eventLayer.name;
      if (engineer in engineerLayers) {
        engineerLayers[engineer].removeFrom(map);
      }
    });

    // Must change these if engineers ever change
    function getColor(engineer) {
      switch (engineer) {
        case 'Mike':
          return 'green';
        case 'Salar':
          return 'blue';
        case 'Diego':
          return 'purple';
        case 'Saul':
          return 'orange';
        default:
          return 'black';
      }
    }




  </script>
</body>

</html>